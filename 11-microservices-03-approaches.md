# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.
  
Обоснуйте свой выбор.

### Решение  


Тут выбрал бы однозначно Gitlab CI CD поскольку он покрывает все указанные требования :

- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);  ( GitLab Variables )
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;  ( встроенный gitlab container  registry )
- возможность развернуть агентов сборки на собственных серверах; (gitlab runners)
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.  
Дополнительные сервисы, в том числе установленные на раннерах  
- docker, docker-compose
- конкретные под каждую задачу решения для тестирования кода , приложений и тд

### Принципы  взаимодействия

код хранится в gitlab, для каждого сервиса свой репозиторий  
Gitlab CI CD настроен смотреть за событиями репозиториев. при появлении запросов на push, merge или вручную - запускается сборка  
При запуске сборки собираем параметры - версия , ветка и т данных. На основе этих данных выбираем определенный шаблон сборки ( разные конфигурации сборок )  
Подгружаем секреты  
Собираем докер контейнер, сохраняем образ в gitlab container  registry  
тестируем на одном из раннеров по заготовленным шаблонам действий  

Мы можем заменить Gitlab CI CD на github Actions  но тогда нужуно будет использовать дополнительные сервисы для реализации функционала раннеров ( у гихаба только селф хост )  
Или вообще использовать gitlab и githab только для версионирования кода, а СI CD настроть на Jenkins. Но тогда придется добавитьи Docker registry , HC Vault или плагин Jenkins Credentials, плагин для взаимодействия с docker. Функции раннеров будут выполнять Jenkins agent  


 

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

# Решение

тут логично использовать EFK     Elastic - Fluent Bit  - Kibana   
приложения просто выводят в stdout все события  
это с помощью Fluent Bit ( или любых filebeat ) передается в Elastic  
с помощью интерфейса Kibana настраивается удобный просмотр, организация и управления шаблонами поиска  
если нам нужно перед передачей преобразовывать логи в какой то общий формат или подгонять под единые требования, то добавил бы еще logstash между beat и Elastic  


## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

# Решение  
Поскольку архитектура микросервисная, то использвал бы крайне популярную связку Prometheus + Graphana. Если бы решение было с бьольшим использованием монолита или многчисленными  hardware решениями то можно было бы использовать Zabbix  
А так данная связка ( Prometheus + Graphana ) позволяет нам соответсвовать всем перечисленным требованиям и при этом относительно небольшими ресурсами  
Особенно учитывая необходимость собирать специфичные метрики - в чем хорош Prometheus  
Сбором метрик займутся Node Exporter, cAdvisor   

---
